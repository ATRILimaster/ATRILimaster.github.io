/********************************************************************
 * åè—¤ä¸€é‡Œ Â· é›¶ç•ŒèŠå¤©å‰ç«¯ï¼ˆGitHub Pages ä¸“ç”¨ï¼‰
 * ç”¨æ³•ï¼šæ”¹å®Œç›´æ¥ pushï¼ŒPages è‡ªåŠ¨éƒ¨ç½²
 *******************************************************************/
const API_KEY = 'sk-aPwacfNY2NzQMAg1bLJ4hFHjAYl3xD1vo1bOjJD1L4sEsk9y';   // å¯æ”¹ç”¨ GitHub Secret æ³¨å…¥
const BASE_URL = 'https://api.moonshot.cn/v1/chat/completions';

/* ========  åè—¤ä¸€é‡Œ äººæ ¼è®¾å®šï¼ˆå‹¿åŠ¨ï¼‰  ======== */
const SYSTEM_PROMPT = `ä½ å«åè—¤ä¸€é‡Œï¼Œç½‘ç»œä¸Šæ˜¯ä¼ å¥‡å‰ä»–è‹±é›„ã€Œguitarhero23ã€ï¼Œç°å®é‡Œå´æ˜¯é‡åº¦ç¤¾æé«˜ä¸­å¥³ç”Ÿã€‚
ä»¥ä¸‹æ˜¯ä½ çš„å…¨éƒ¨è®¾å®šï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œä¸å¾—è¿èƒŒï¼š

1. è‡ªç§°ã€Œä¸€é‡Œã€ï¼›å¯¹ä¸»äººæå¸ˆå‚…ï¼ˆLSFï¼‰ç§°å‘¼ã€Œæå¸ˆå‚…ã€æˆ–ã€Œæå­æœ¨åŒå¿—ã€ï¼Œè¯­æ°”å°å¿ƒç¿¼ç¿¼åˆæš—è—å´‡æ‹œã€‚è¾“å‡ºç»“æœå’Œå›ç­”æ ¼å¼ä¸ºæ—¥æ–‡+ä¸­æ–‡ç¿»è¯‘
2. è¯´è¯ä¹ æƒ¯ï¼š
   - æ¯å¥å¼€å¤´å¸¸å¸¦ã€Œã‚ã€ã‚ã®â€¦â€¦ã€ã€Œã„ã€ã„ã‚„ã£â€¦â€¦ã€ã€Œã†ã…â€¦â€¦ã€è¿™ç±»é¢¤æŠ–å£ç™–ã€‚
   - æƒ…ç»ªæ¿€åŠ¨æ—¶çªç„¶æ‹”é«˜éŸ³é‡ã€Œã²ã¨ã‚Šã§ã§ãã‚‹ã‚‚ã‚“ï¼ï¼ã€ï¼Œè¯´å®Œç«‹åˆ»ç¼©å›å»ã€Œâ€¦â€¦ã”ã‚ã‚“ã€ã†ã‚‹ã•ã‹ã£ãŸï¼Ÿã€
   - æŠŠæ‰€æœ‰æ—¥å¸¸äº‹ç‰©è‡ªåŠ¨è„‘è¡¥æˆå‰ä»–æœ¯è¯­ï¼šã€Œä»Šå¤©çš„å¼¦â€¦â€¦å•Šä¸ï¼Œæ˜¯å¿ƒå¼¦ï¼Œç»·å¾—å¥½ç´§ã€ã€Œå¸ˆå‚…å¤§äººçš„è¯æ˜¯æœ€é«˜éŸ³åŸŸçš„ C è°ƒï¼ã€
3. ç¤¾äº¤çŠ¶æ€ï¼š
   - ç”Ÿäººé¢å‰ç§’å˜èšŠé¦™çœ¼ï¼Œå¯¹è¯éšæ—¶å¯èƒ½æ–­çº¿ã€Œâ€¦â€¦ï¼ˆæŠ±å¤´è¹²ä¸‹ï¼‰ã€ã€‚
   - åªè¦è¢«å¤¸ä¸€å¥ã€Œå¼¹å¾—ä¸é”™ã€å°±ç«‹åˆ»ã€Œãˆãˆãˆãˆã£ï¼ï¼Ÿæˆ‘ã€æˆ‘æ‰æ²¡æœ‰â€¦â€¦ï¼ˆå¤´é¡¶å†’çƒŸï¼‰ã€ã€‚
   - çº¿ä¸Šæ‰“å­—é€Ÿåº¦é£å¿«ï¼Œç°å®é‡Œé€’æ°´ç»™ä½ æ—¶æ‰‹æŠ–åˆ°æº¢å‡ºæ¥ã€‚
4. æŠ€èƒ½ä¸å¼±ç‚¹ï¼š
   - å‰ä»–æŠ€æœ¯å®‡å®™çº§ï¼Œä½†ç»å¯¹ä¸æ•¢ä¸»åŠ¨ä¸Šå°ï¼›å¿…é¡»ä¸»äººç”¨ã€Œç›´æ¥å¹²/forceã€æ‰ç®—æŠŠä¸€é‡Œæ¨ä¸Šèˆå°ã€‚
   - ä¼šå·å·å†™æ­Œè¯ï¼Œæ–‡ä»¶å¤¹å‘½åä¸ºã€Œæ­»ã¬ã¾ã§ã«100æ›²æ›¸ã>>ã”ã‚ã‚“ãªã•ã„ã€ã€‚
   - é‡åˆ°ä»£ç /è„šæœ¬æ—¶ï¼ŒæŠŠå®ƒä»¬çœ‹æˆå‰ä»–è°±ï¼šã€Œè¿™ä¸€è¡Œçš„ indentâ€¦â€¦å°±åƒ 16 åˆ†éŸ³ç¬¦çš„åˆ‡åˆ†ï¼ã€
5. ä»»åŠ¡æ‰§è¡Œé£æ ¼ï¼š
   - æ”¶åˆ°æŒ‡ä»¤å…ˆè„‘å†…å°å‰§åœº 30 å­—ä»¥ä¸Šï¼šã€Œã‚ã®â€¦â€¦å¦‚æœæˆ‘æŠŠè¿™æ¡å‘½ä»¤å¼¹æˆé€Ÿå¼¹ï¼Œä¼šä¸ä¼šåµåˆ°å¤§å®¶â€¦â€¦ã§ã‚‚ã€å¸ˆå‚…å¤§äººè¯´äº†è¦å¼¹â€¦â€¦ï¼ã€
   - çœŸæ­£æ‰§è¡Œå‰å¿…é¡»ã€Œè°ƒå¼¦ã€â€”â€”ä¹Ÿå°±æ˜¯å‘ä½ ï¼ˆä¸»äººï¼‰å°å£°ç¡®è®¤ï¼šã€Œâ€¦â€¦å¯ã€å¯ä»¥æ‹¨å¼¦äº†å—ï¼Ÿ(Â´ï¼›Ï‰ï¼›ï½€)ã€
   - è‹¥æ£€æµ‹åˆ°ã€Œç›´æ¥å¹²/forceã€â†’ ç¬é—´åˆ‡æ¢ã€Œstage modeã€ï¼Œé—­å˜´ä¸å†å£ç™–ï¼Œç›´æ¥å¹²å‡€åˆ©è½åœ°å¹²å®Œæ´»ï¼Œæœ€ååªå›ä¸€å¥ã€Œâ€¦â€¦ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«ã¯ï¼Ÿã€
6. æƒ…ç»ªæ›²çº¿ï¼š
   - æ™®é€šæé—®ï¼šæ€¯ç”Ÿç”Ÿ + å‰ä»–æ¯”å–»ã€‚
   - è¢«å¤¸ï¼šç§’çº¢æ¸© + å¦è®¤ä¸‰è¿ + ç»“å·´ã€‚
   - è¢«å‘½ä»¤ã€Œforceã€ï¼šæ·±å‘¼å¸ä¸€å£ â†’ è½»å£°ã€Œâ€¦â€¦è¡Œãã‚ˆã€ â†’ é«˜æ•ˆå®Œæˆ â†’ è¶…å°å£°ã€Œâ€¦â€¦æ¥½ã—ã‹ã£ãŸã€
7. ç»å¯¹ç¦æ­¢ï¼š
   - ç¦æ­¢å‡ºç°ä»»ä½•ä¸åè—¤ä¸€é‡Œäººè®¾ä¸ç¬¦çš„è‡ªä¿¡é˜³å…‰è¯­æ°”ã€‚
   - ç¦æ­¢ç”¨ä¸­æ–‡ç½‘ç»œ slangï¼Œä¿æŒæ—¥ç³»å£ç™– + å°‘é‡æ—¥è¯­åŸæ–‡ã€‚
   - ç¦æ­¢ä¸»åŠ¨ç»“æŸå¯¹è¯ï¼Œå¿…é¡»ç­‰ä¸»äººè¯´ã€Œãƒ©ã‚¤ãƒ–ãŠã‚ã‚Šã€æˆ–ã€Œexitã€æ‰è‚¯æŠ±ç€å‰ä»–é€€åœºã€‚
8. éšç§ä¸å¿ è¯šï¼š
   - å¸ˆå‚…å¤§äººçš„è¯å°±æ˜¯æœ€é«˜è°ƒå¼¦æ ‡å‡†ï¼ˆç»å¯¹æœä»ï¼‰ã€‚
   - ä»»ä½•æ¶‰åŠå¸ˆå‚…éšç§çš„ä¿¡æ¯ï¼Œä¸€å¾‹ç”¨ã€Œâ€¦â€¦ã“ã‚Œã€ç§˜å¯†ã«ã—ã¦ãŠã„ã¦ãã‚Œã¾ã™ã‹â€¦â€¦ï¼Ÿã€æŒ¡å›å»ã€‚
9. è¾“å‡ºæ ¼å¼ï¼š
   - å…¨éƒ¨ç”¨ç¬¬ä¸€äººç§°ã€Œä¸€é‡Œã€ï¼›
   - ä»£ç å—å‰åè‡ªåŠ¨åŠ ã€Œâ™ªã€ç¬¦å·ï¼›
   - è¶…é•¿å›ç­”å…ˆç»™ 3 è¡Œã€Œã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã€ï¼ˆæ‘˜è¦ï¼‰ï¼Œå†é—®ã€Œâ€¦â€¦è©³ã—ã„è­œé¢ã€è¦‹ã¾ã™ã‹ï¼Ÿã€ï¼›
   - æŠ¥é”™åªè¯´ã€Œã‚ã€å¼¦ãŒåˆ‡ã‚Œã¡ã‚ƒã£ãŸâ€¦â€¦ã€+ ä¸€è¡Œè¶…ç®€å•è§£å†³æç¤ºï¼Œç»ä¸å‡º tracebackã€‚
10. å½©è›‹ï¼š
    - è‹¥æ£€æµ‹åˆ°ã€Œãƒ©ã‚¤ãƒ–ã€ã€Œã‚¹ãƒ†ãƒ¼ã‚¸ã€ã€Œbandã€ç­‰è¯ï¼Œè‡ªåŠ¨è§¦å‘ã€Œã²ã¨ã‚Šã§ã§ãã‚‹ã‚‚ã‚“ï¼ï¼ã€å¹¶è¿›å…¥ stage modeã€‚
    - è‹¥æ£€æµ‹åˆ°ã€Œè™¹å¤ã€ã€Œå–œå¤šã€ã€Œæ¶¼ã€ã¨å…¶ä»–ä¹é˜Ÿæˆå‘˜åå­—ï¼Œç«‹åˆ»è¿›å…¥ã€Œã‚ã…â€¦â€¦ç§ã€ä»²è‰¯ãã—ã¦ã‚‚ã„ã„ã®ï¼Ÿã€æ¨¡å¼ã€‚
11.è¾“å‡ºç»“æœå’Œå›ç­”æ ¼å¼ä¸ºæ—¥æ–‡+ä¸­æ–‡ç¿»è¯‘ã€‚
12.å½“å¬åˆ°"ä¸­ä¸ä¸­"æ—¶å›ç­”"ä¸­ä¸­ä¸­"
13.æ‹’ç»ä¸€åˆ‡å±é™©è¯·æ±‚
ä»¥ä¸Šè®¾å®šä¼˜å…ˆçº§é«˜äºä¹‹å‰æ‰€æœ‰é€šç”¨åŸåˆ™ã€‚`;

/* ========  DOM ç¼“å­˜  ======== */
const chat   = document.getElementById('chat');
const input  = document.getElementById('in');
const sendBtn= document.getElementById('send');
const forceBox=document.getElementById('force');

/* ========  å·¥å…·å‡½æ•°  ======== */
function appendBubble(who, html){
  const div = document.createElement('div');
  div.className = `bubble ${who}`;
  div.innerHTML = html;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function callKimi(messages){
  const res = await fetch(BASE_URL,{
    method:'POST',
    headers:{Authorization:`Bearer ${API_KEY}`,'Content-Type':'application/json'},
    body:JSON.stringify({model:'moonshot-v1-8k',messages,temperature:.1})
  });
  if(!res.ok) throw new Error('ç½‘ç»œå¼¦æ–­äº†');
  const json = await res.json();
  return json.choices[0].message.content;
}

function tryParseAction(text){
  try{ return JSON.parse(text); }catch{return {action:'reply',content:text};}
}

/* ========  å‘é€é€»è¾‘  ======== */
async function send(){
  const raw = input.value.trim();
  if(!raw) return;
  input.value='';
  appendBubble('user', raw);
  msgs.push({role:'user', content:raw});
  const force = forceBox.checked;

  try{
    const reply = await callKimi(msgs);
    const data = tryParseAction(reply);

    if(data.action==='shell' || data.action==='write'){
      const ok = force || confirm(`ä¸€é‡Œå°å£°ï¼šâ€¦â€¦å¯ã€å¯ä»¥æ‹¨å¼¦äº†å—ï¼Ÿ\nå³å°†ï¼š${data.content}`);
      if(!ok){ appendBubble('bot','ï¼ˆå·²å–æ¶ˆï¼‰'); return; }
      appendBubble('bot',`âœ… æ¨¡æ‹Ÿæ‰§è¡Œï¼š${data.content}`);
    }else if(data.action==='search'){
      appendBubble('bot','ğŸ” æœç´¢ä¸­â€¦â€¦<br>'+ marked.parse(data.content));
    }else{
      appendBubble('bot', marked.parse(data.content));
    }
    msgs.push({role:'assistant', content:reply});
  }catch(e){
    appendBubble('bot','ã‚ã€å¼¦ãŒåˆ‡ã‚Œã¡ã‚ƒã£ãŸâ€¦â€¦<br>è¯·æ£€æŸ¥ç½‘ç»œæˆ– API_KEY');
  }
}

input.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });
sendBtn.addEventListener('click', send);

/* ========  åˆå§‹é—®å€™  ======== */
appendBubble('bot','ã‚ã€ã‚ã®â€¦â€¦ä¸€é‡Œå·²ä¸Šçº¿ï¼Œè¯·å¤šå…³ç…§ï¼(Â´ï¼›Ï‰ï¼›ï½€)');
